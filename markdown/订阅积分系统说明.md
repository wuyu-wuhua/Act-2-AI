# 订阅积分系统说明

## 系统概述

本系统实现了完整的订阅积分管理逻辑，确保用户在订阅周期内的积分使用和续期时的积分重置都符合业务规则。

## 核心业务逻辑

### 1. 订阅积分管理规则

#### 订阅创建时
- 用户购买订阅套餐后，立即获得对应的积分
- 例如：基础版月付获得1300积分，专业版年付获得50000积分

#### 订阅续期时
- 当订阅自动续期成功时，积分会重置为套餐赠送的积分数量
- 例如：基础版月付续期后，积分重置为1300积分
- 例如：专业版年付续期后，积分重置为50000积分

#### 订阅取消后
- 用户在订阅周期结束前取消订阅：
  - 取消后仍可使用积分直到当前周期结束
  - 周期结束后，积分自动清零
- 订阅被立即删除时，积分立即清零

#### 支付失败时
- 支付失败次数达到3次后，订阅积分自动清零

### 2. 技术实现

#### Webhook事件处理
系统通过Stripe Webhook处理以下事件：
- `checkout.session.completed`: 支付完成
- `customer.subscription.created`: 订阅创建
- `customer.subscription.updated`: 订阅更新（包括取消）
- `customer.subscription.deleted`: 订阅删除
- `invoice.payment_succeeded`: 发票支付成功（续期）
- `invoice.payment_failed`: 发票支付失败

#### 积分清零时机
1. **订阅周期结束时**：通过Webhook检测订阅状态
2. **定时清理任务**：通过API端点定期清理过期订阅
3. **支付失败后**：达到最大重试次数时清零

#### 积分重置时机
1. **订阅续期成功**：检测到续期付款时重置
2. **新订阅创建**：首次订阅时设置积分

## API端点说明

### 1. Stripe Webhook
**路径**: `/api/webhooks/stripe`
**方法**: POST
**功能**: 处理Stripe的所有订阅相关事件

### 2. 订阅清理API
**路径**: `/api/subscription/cleanup`
**方法**: 
- POST: 执行清理任务（需要API密钥）
- GET: 手动触发清理（用于测试）

**功能**: 清理过期的订阅积分

## 环境变量配置

在 `.env.local` 文件中添加以下配置：

```bash
# 订阅清理API密钥
CLEANUP_API_KEY="your-cleanup-api-secret-key-here-change-this-in-production"
```

## 使用方法

### 1. 自动处理
系统会自动处理以下情况：
- 订阅创建、续期、取消、删除
- 积分清零和重置
- 支付失败处理

### 2. 手动清理
可以通过以下方式手动触发清理：

```bash
# 使用API密钥调用清理接口
curl -X POST /api/subscription/cleanup \
  -H "Authorization: Bearer your-cleanup-api-key"

# 或者直接GET请求（用于测试）
curl /api/subscription/cleanup
```

### 3. 定时任务设置
建议设置定时任务，每天执行一次清理：

```bash
# 使用cron设置定时任务
0 2 * * * curl -X POST https://yourdomain.com/api/subscription/cleanup \
  -H "Authorization: Bearer your-cleanup-api-key"
```

## 数据库表结构

### 主要表
- `act_users`: 用户信息和积分余额
- `act_credit_transactions`: 积分交易历史
- `act_subscription_plans`: 订阅计划配置

### 关键字段
- `credits_balance`: 用户当前积分余额
- `subscription_status`: 订阅状态
- `subscription_end_date`: 订阅结束日期
- `transaction_type`: 交易类型（purchase, consumption, refund, bonus）

## 监控和日志

### 1. 日志记录
系统会记录所有关键操作：
- 积分更新、清零、重置
- 订阅状态变更
- 错误和异常情况

### 2. 监控指标
- 订阅创建和续期数量
- 积分清零和重置次数
- 支付失败率
- 清理任务执行状态

## 故障排除

### 常见问题

1. **积分未清零**
   - 检查Webhook是否正常接收
   - 验证订阅状态是否正确
   - 手动触发清理任务

2. **积分未重置**
   - 确认续期付款是否成功
   - 检查Webhook事件处理
   - 查看日志中的错误信息

3. **清理任务失败**
   - 验证API密钥配置
   - 检查数据库连接
   - 查看错误日志

### 调试方法

1. **查看Webhook日志**
   - 检查Stripe Dashboard中的Webhook事件
   - 查看应用日志中的Webhook处理记录

2. **测试清理API**
   - 使用GET请求测试清理功能
   - 检查返回的统计信息

3. **数据库查询**
   - 直接查询用户积分状态
   - 检查交易历史记录

## 安全考虑

1. **API密钥保护**
   - 使用强密码作为清理API密钥
   - 定期更换密钥
   - 限制API访问权限

2. **Webhook验证**
   - 验证Stripe签名
   - 使用HTTPS端点
   - 实现幂等性处理

3. **数据保护**
   - 敏感操作记录日志
   - 实现错误重试机制
   - 定期备份数据

## 性能优化

1. **数据库索引**
   - 为常用查询字段添加索引
   - 优化清理查询性能

2. **批量处理**
   - 清理任务批量处理过期订阅
   - 减少数据库操作次数

3. **缓存策略**
   - 缓存用户订阅状态
   - 减少重复查询

## 总结

本系统实现了完整的订阅积分管理逻辑，确保：
- 订阅创建时正确分配积分
- 订阅续期时重置积分为套餐数量
- 订阅取消后及时清零积分
- 支付失败时自动处理
- 提供手动清理和监控功能

通过Webhook自动处理和定时清理任务，系统能够可靠地管理用户的订阅积分，满足业务需求。 