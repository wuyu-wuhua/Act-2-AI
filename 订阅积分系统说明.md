# 订阅积分系统说明

## 概述

本系统实现了完整的订阅积分管理功能，包括订阅积分的自动清零、续期重置等功能。

## 主要功能

### 1. 订阅积分清零
- **取消订阅后清零**：当用户在订阅期间取消订阅时，订阅积分会在订阅到期时自动清零
- **订阅过期清零**：当订阅自然到期时，订阅积分也会自动清零
- **保留充值积分**：清零操作只影响订阅积分，充值积分保持不变

### 2. 订阅续期积分重置
- **续期检测**：系统会自动检测订阅续期（新订阅开始日期在当前订阅结束日期之后）
- **积分重置**：续期时，订阅积分会重置到新套餐对应的积分数量
- **充值积分保留**：续期时充值积分保持不变

## 数据库结构

### 用户表 (act_users)
```sql
-- 订阅相关字段
subscription_status VARCHAR(20) DEFAULT 'none' -- none, active, cancelled, expired
subscription_start_date TIMESTAMP NULL
subscription_end_date TIMESTAMP NULL
subscription_cancelled_date TIMESTAMP NULL
subscription_plan_id VARCHAR(100) NULL
subscription_credits INTEGER DEFAULT 0
recharge_credits INTEGER DEFAULT 0
credits_balance INTEGER DEFAULT 0
```

### 订阅状态跟踪表 (act_subscription_status)
```sql
-- 记录订阅状态变更历史
user_id UUID NOT NULL
subscription_status VARCHAR(20) NOT NULL
subscription_plan_id VARCHAR(100) NULL
subscription_start_date TIMESTAMP NULL
subscription_end_date TIMESTAMP NULL
subscription_cancelled_date TIMESTAMP NULL
credits_at_start INTEGER DEFAULT 0
credits_at_cancellation INTEGER DEFAULT 0
credits_at_expiry INTEGER DEFAULT 0
description TEXT
```

## API接口

### 1. 订阅取消
```http
POST /api/subscription/cancel
Content-Type: application/json

{
  "userId": "user-uuid",
  "reason": "用户取消订阅"
}
```

### 2. 订阅清理
```http
POST /api/subscription/cleanup
```
- 处理所有过期的订阅积分
- 自动清零已取消或已过期的订阅积分

### 3. 查询过期订阅状态
```http
GET /api/subscription/cleanup
```
- 查看即将过期的订阅
- 查看需要清理的订阅候选

## 数据库函数

### 1. cancel_subscription()
- 处理订阅取消
- 更新订阅状态为已取消
- 记录取消时间

### 2. expire_subscription_credits()
- 处理订阅积分过期清零
- 只清零订阅积分，保留充值积分
- 记录清零交易历史

### 3. renew_subscription_credits()
- 处理订阅续期积分重置
- 重置订阅积分为新套餐数量
- 记录重置交易历史

### 4. process_expired_subscriptions()
- 批量处理过期的订阅
- 查找所有需要清理的订阅
- 调用expire_subscription_credits()处理

### 5. daily_subscription_cleanup()
- 定时任务函数
- 处理所有过期的订阅积分
- 记录清理日志

## 使用示例

### 1. 订阅取消流程
```javascript
// 1. 用户取消订阅
const cancelResponse = await fetch('/api/subscription/cancel', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId: 'user-uuid',
    reason: '用户取消订阅'
  })
});

// 2. 订阅状态更新为cancelled
// 3. 订阅积分在到期时自动清零
```

### 2. 订阅续期流程
```javascript
// 1. 用户续期订阅（通过Stripe webhook或直接购买）
// 2. 系统检测到续期（新开始日期 > 当前结束日期）
// 3. 调用renew_subscription_credits()重置积分
// 4. 订阅积分重置为新套餐数量
```

### 3. 定时清理
```javascript
// 1. 设置定时任务调用清理API
// 2. 系统自动处理过期订阅
// 3. 记录清理结果和统计信息
```

## 配置说明

### 1. 定时任务设置
建议设置每日定时任务来清理过期的订阅积分：

```bash
# 每天凌晨2点执行清理
0 2 * * * curl -X POST https://your-domain.com/api/subscription/cleanup
```

### 2. 环境变量
确保以下环境变量已正确配置：
```env
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
STRIPE_WEBHOOK_SECRET=your-stripe-webhook-secret
```

## 注意事项

1. **积分清零时机**：订阅积分只在订阅到期时清零，不会立即清零
2. **充值积分保护**：所有清零操作都不会影响充值积分
3. **续期检测**：系统通过比较订阅开始日期和当前订阅结束日期来判断是否为续期
4. **交易记录**：所有积分变更都会记录在act_credit_transactions表中
5. **状态跟踪**：所有订阅状态变更都会记录在act_subscription_status表中

## 故障排除

### 1. 订阅积分未清零
- 检查订阅结束日期是否已过期
- 检查订阅状态是否为cancelled或active
- 手动调用清理API：`POST /api/subscription/cleanup`

### 2. 续期积分未重置
- 检查新订阅开始日期是否在当前订阅结束日期之后
- 检查订阅状态是否为active
- 查看webhook日志确认续期检测

### 3. 数据库函数错误
- 检查数据库函数是否已正确创建
- 查看数据库日志确认函数执行情况
- 验证用户ID和参数格式

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 实现订阅积分清零功能
- 实现订阅续期积分重置功能
- 添加完整的API接口和数据库函数
- 添加定时清理功能 