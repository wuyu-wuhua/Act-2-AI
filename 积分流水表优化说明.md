# 积分流水表优化说明

## 概述
为了改善用户体验，我们将 `act_credit_purchases` 表优化为完整的积分流水表，确保积分概览能及时显示最新的积分记录。

## 优化内容

### 1. 表结构优化
- 重新设计 `act_credit_purchases` 表结构
- 添加完整的积分流水字段
- 支持多种交易类型（购买、订阅、奖励、消费、退款）
- 记录交易前后的积分余额

### 2. 字段说明
- `transaction_type`: 交易类型（purchase, subscription, bonus, consumption, refund）
- `credits_amount`: 积分数量（正数为获得，负数为消费）
- `balance_before`: 交易前余额
- `balance_after`: 交易后余额
- `amount_paid`: 支付金额
- `package_name`: 套餐名称
- `description`: 交易描述

### 3. 执行步骤

#### 步骤1：执行SQL脚本
在Supabase的SQL编辑器中执行 `optimize_credit_purchases_table.sql` 文件中的SQL语句。

#### 步骤2：验证表结构
执行以下SQL查询验证表是否正确创建：
```sql
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'act_credit_purchases';
```

#### 步骤3：测试积分更新
订阅成功后，检查以下表是否有新记录：
- `act_users` - 积分余额更新
- `act_credit_transactions` - 交易历史记录
- `act_credit_purchases` - 积分流水记录

## 功能改进

### 1. 积分更新API
- 同时更新两个表的记录
- 确保数据一致性
- 提供详细的交易信息

### 2. 个人中心页面
- 从两个表合并显示交易记录
- 实时更新积分统计
- 显示完整的交易历史

### 3. 用户体验
- 订阅成功后立即显示积分更新
- 交易记录清晰可见
- 积分概览及时准确

## 预期效果
1. 用户订阅后立即看到积分增加
2. 交易记录完整准确
3. 积分概览实时更新
4. 提升用户对网站的信任度

## 注意事项
- 执行SQL脚本前请备份现有数据
- 确保数据库权限正确
- 测试所有功能正常工作 