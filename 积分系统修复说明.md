# 积分系统修复说明

## 问题原因

您遇到的积分问题主要是由于**数据类型不匹配**导致的：

1. **Supabase Auth 返回的用户ID是UUID格式**（如：`c6cf518d-4be5-48c3-a3a1-e3c54423f591`）
2. **数据库中的用户ID字段是BIGINT类型**（整数）
3. 当代码尝试将UUID字符串插入到BIGINT字段时，PostgreSQL报错：`invalid input syntax for type bigint`

## 解决方案

### 1. 更新数据库结构

我已经修改了以下文件：
- `database_schema.sql` - 主数据库模式
- `init_database.sql` - 初始化脚本

**主要变更：**
- 将 `act_users.id` 从 `BIGSERIAL` 改为 `UUID`
- 将所有相关表的 `user_id` 字段从 `BIGINT` 改为 `UUID`
- 添加了 `act_credit_transactions` 表的完整定义

### 2. 执行数据库迁移

**重要：** 您需要在Supabase控制台中执行 `migrate_to_uuid.sql` 脚本来更新数据库结构。

**步骤：**
1. 登录Supabase控制台
2. 进入SQL编辑器
3. 复制 `migrate_to_uuid.sql` 的内容并执行
4. 执行完成后，所有现有用户数据将被清除（因为ID格式改变）

### 3. 代码修复

我已经修复了以下文件：
- `app/login/page.tsx` - 改进了用户创建和积分赠送逻辑
- `app/api/credits/route.ts` - 改进了错误处理，支持UUID格式的用户ID

## 测试步骤

### 1. 执行数据库迁移
```sql
-- 在Supabase控制台执行 migrate_to_uuid.sql
```

### 2. 重新注册用户
由于用户ID格式改变，需要重新注册用户。

### 3. 测试积分系统
在浏览器控制台中运行 `test_credits.js` 脚本：
```javascript
// 复制 test_credits.js 的内容到浏览器控制台执行
```

### 4. 验证积分赠送
1. 使用新账号登录
2. 检查个人中心页面
3. 应该看到50积分的欢迎奖励

## 预期结果

修复后，新用户登录时应该：
1. 自动创建用户记录（使用UUID格式的ID）
2. 自动获得50积分欢迎奖励
3. 在个人中心页面显示正确的积分余额

## 注意事项

1. **数据丢失**：执行迁移脚本会清除所有现有用户数据
2. **重新注册**：所有用户需要重新注册
3. **测试环境**：建议先在测试环境中验证修复效果

## 故障排除

如果仍有问题，请检查：
1. 数据库迁移是否成功执行
2. 浏览器控制台是否有错误信息
3. Supabase日志中是否有相关错误

## 联系支持

如果问题仍然存在，请提供：
1. 浏览器控制台的错误信息
2. Supabase日志中的错误信息
3. 具体的操作步骤 